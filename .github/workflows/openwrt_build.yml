
name: OpenWrt Build CI

on:
  push:
    branches: 
      - master
    tags:
      - 'v*'
  # schedule:
  #   - cron: 0 20 * * *
  #release:
  #  types: [published]
  workflow_dispatch:

jobs:
  build:
    name: Build x86_64 OpenWrt Firmware
    runs-on: ubuntu-24.04
    if: github.event.repository.owner.id == github.event.sender.id
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: openwrt-musl-lite
            config: base_musl_config
            target: musl
          - name: openwrt-glibc-lite
            config: base_glibc_config
            target: glibc
          - name: openwrt-musl-full
            config: full_musl_config
            target: musl
          - name: openwrt-glibc-full
            config: full_glibc_config
            target: glibc
            
    steps:
      - name: Set workspace
        run: |
          sudo mkdir -p -m 777 /mnt/openwrt
          echo "WORK_PATH=/mnt/openwrt" >> $GITHUB_ENV
          sudo -E timedatectl set-timezone Asia/Shanghai
      - name: Checkout
        uses: actions/checkout@v6
        with:
          path: openwrt
          
      - name: Configure compilation environment
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo apt update -y
          sudo apt full-upgrade -y
          sudo apt install -y ack antlr3 aria2 asciidoc autoconf automake autopoint binutils bison btrfs-progs build-essential \
            bzip2 ca-certificates ccache clang cmake coreutils cpio curl device-tree-compiler ecj fakeroot fastjar flex g++-multilib \
            gawk gcc-multilib genisoimage gettext git gnutls-dev gperf gzip haveged help2man intltool irqbalance jq lib32gcc-s1 \
            libc6-dev-i386 libelf-dev libfuse-dev libglib2.0-dev libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev libncurses-dev \
            libncurses5-dev libncursesw5-dev libnsl-dev libpython3-dev libreadline-dev libssl-dev libtool libyaml-dev libz-dev \
            lld llvm lrzsz mkisofs msmtp nano ninja-build ntpdate p7zip p7zip-full patch pigz pkgconf python3 python3-cryptography \
            python3-docutils python3-pip python3-ply python3-pyelftools python3-requests python3-setuptools qemu-utils quilt \
            re2c rsync scons sharutils squashfs-tools subversion swig tar texinfo uglifyjs unzip upx-ucl vim wget \
            xmlto xsltproc xxd xz-utils yasm zip zlib1g-dev zstd
          df -h
      - name: Install GCC 14 and set default
        run: |
          sudo apt-get install -y gcc-14 g++-14 g++-14-multilib gcc-14-multilib
          sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-14 60
          sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-14 60
          echo "gcc version:$(gcc --version)"
          echo "g++ version:$(g++ --version)"

      - name: Install rustup and Rust toolchain
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain stable
          export PATH="$HOME/.cargo/bin:$PATH"
          rustup component add clippy rustfmt
          echo "rustc version:$(rustc --version)"
          echo "cargo version:$(cargo --version)"

      - name: Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version: '24'

      - name: Change Build Path
        run: |
          sudo rsync -a "$GITHUB_WORKSPACE/openwrt/" ${{ env.WORK_PATH }}/
          
      - name: Update feeds
        working-directory: ${{ env.WORK_PATH }}
        run: |
          ./tool.sh feed

      - name: Generate configuration file
        working-directory: ${{ env.WORK_PATH }}
        run: |
          rm -f ./.config*
          cp ./configs/${{ matrix.config }} ./.config
          make defconfig

      - name: Make download
        working-directory: ${{ env.WORK_PATH }}
        run: |
          make download -j8 || make download -j1 V=s
          df -h
          
      - name: Compile firmware
        run: |
          cd ${{ env.WORK_PATH }}
          if [[ "${{ matrix.target }}" == "glibc" ]]; then
            sed -i 's/--set=llvm\.download-ci-llvm=true/--set=llvm.download-ci-llvm=false/' ./feeds/packages/lang/rust/Makefile
          fi
          make -j$(nproc)  || make -j1 V=s      

      - name: Clean Build Files
        working-directory: ${{ env.WORK_PATH }}
        run: |
          rm -rf ./staging_dir
          rm -rf ./build_dir

      - name: Prepare artifact
        working-directory: ${{ env.WORK_PATH }}
        run: |
          mkdir -p ./artifact/firmware
          mkdir -p ./artifact/buildinfo
          rm -rf $(find ./bin/targets/ -type d -name "packages")
          cp -rf $(find ./bin/targets/ -type f -name "immortalwrt-*") ./artifact/firmware/
          cp -rf $(find ./bin/targets/ -type f -name "sha256sums") ./artifact/firmware/
          cp -rf $(find ./bin/targets/ -type f -name "*.buildinfo" -o -name "*.manifest") ./artifact/buildinfo/

      - name: Clean Bin Files
        working-directory: ${{ env.WORK_PATH }}
        run: |
          rm -rf ./bin

      - name: Deliver buildinfo
        uses: actions/upload-artifact@v6
        with:
          name: ${{ matrix.name }}-buildinfo
          path: ${{ env.WORK_PATH }}/artifact/buildinfo/

      - name: Deliver firmware
        uses: actions/upload-artifact@v6
        with:
          name: ${{ matrix.name }}
          path: ${{ env.WORK_PATH }}/artifact/firmware/

  push_snapshot_msg:
    name: push weixing msg
    needs: build
    runs-on: ubuntu-24.04
    if: (!startsWith(github.ref, 'refs/tags/v'))
    steps:
      - name: Push Msg
        run: |
          sudo -E timedatectl set-timezone Asia/Shanghai
          sh .github/push.sh ${{ secrets.CORPID }} ${{ secrets.CORPSECRET }} ${{ secrets.AGENTID }} "x86_64" "Snapshot on ${{ github.ref_name }}"

  release_build:
    name: Release x86_64 OpenWrt Firmware
    needs: build
    runs-on: ubuntu-24.04
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Set workspace
        run: |
          mkdir -p firmware

      - name: Download all artifacts
        uses: actions/download-artifact@v7
        with:
          path: artifacts

      - name: rename firmware
        run: |
          mv artifacts/openwrt-musl-lite/immortalwrt-x86-64-generic-erofs-combined.img.gz firmware/immortalwrt-x86_64-musl-lite-erofs-combined-${{ github.ref_name }}.img.gz
          mv artifacts/openwrt-musl-lite/immortalwrt-x86-64-generic-erofs-combined.qcow2 firmware/immortalwrt-x86_64-musl-lite-erofs-combined-${{ github.ref_name }}.qcow2
          mv artifacts/openwrt-glibc-lite/immortalwrt-x86-64-generic-erofs-combined.img.gz firmware/immortalwrt-x86_64-glibc-lite-erofs-combined-${{ github.ref_name }}.img.gz
          mv artifacts/openwrt-glibc-lite/immortalwrt-x86-64-generic-erofs-combined.qcow2 firmware/immortalwrt-x86_64-glibc-lite-erofs-combined-${{ github.ref_name }}.qcow2
          mv artifacts/openwrt-musl-full/immortalwrt-x86-64-generic-erofs-combined.img.gz firmware/immortalwrt-x86_64-musl-full-erofs-combined-${{ github.ref_name }}.img.gz
          mv artifacts/openwrt-musl-full/immortalwrt-x86-64-generic-erofs-combined.qcow2 firmware/immortalwrt-x86_64-musl-full-erofs-combined-${{ github.ref_name }}.qcow2
          mv artifacts/openwrt-glibc-full/immortalwrt-x86-64-generic-erofs-combined.img.gz firmware/immortalwrt-x86_64-glibc-full-erofs-combined-${{ github.ref_name }}.img.gz
          mv artifacts/openwrt-glibc-full/immortalwrt-x86-64-generic-erofs-combined.qcow2 firmware/immortalwrt-x86_64-glibc-full-erofs-combined-${{ github.ref_name }}.qcow2

      - name: Check SHA256
        run: |
          cd firmware
          for file in *; do
            sha256sum "$file" >> ../sha256sums
          done
          mv ../sha256sums .

      - name: Upload release asset
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.RELEASE_TOKEN }}
          file: firmware/*
          overwrite: true
          release_name: ${{ github.ref_name }}
          tag: ${{ github.ref_name }}
          file_glob: true
          body: |
            release ${{ github.ref_name }}
  
      - name: Delete loder releases
        uses: dev-drprasad/delete-older-releases@v0.3.3
        with:
          keep_latest: 5
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN }}

      - name: Push Msg
        run: |
          sudo -E timedatectl set-timezone Asia/Shanghai
          sh .github/push.sh ${{ secrets.CORPID }} ${{ secrets.CORPSECRET }} ${{ secrets.AGENTID }} "x86_64" "Released on ${{ github.ref_name }}"



